var picture,fetchedLocation,shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),titleInput=document.querySelector("#title"),locationInput=document.querySelector("#location"),videoPlayer=document.querySelector("#player"),captureButton=document.querySelector("#capture-btn"),canvasElement=document.querySelector("#canvas"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader");function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(o){var n=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return n?new Promise(function(e,t){n.call(navigator,o,e,t)}):Promise.reject(new Error("getUserMedia is not implemented!"))});navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){videoPlayer.srcObject=e,videoPlayer.style.display="block"}).catch(function(e){console.log(e),imagePickerArea.style.display="block"})}function initializeLocation(){"geolocation"in navigator||(locationBtn.style.display="none")}function openCreatePostModal(){setTimeout(function(){createPostArea.style.transform="translateY(0)"},1),initializeMedia(),initializeLocation(),deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then(function(e){console.log(e.outcome),"dismissed"===e.outcome?console.log("User cancelled installation"):console.log("User added to home screen")}),deferredPrompt=null)}function closeCreatePostModal(){setTimeout(function(){createPostArea.style.transform="translateY(100vh)"},1),imagePickerArea.style.display="none",videoPlayer.style.display="none",canvasElement.style.display="none",captureButton.style.display="inline",locationBtn.style.display="inline",locationLoader.style.display="none",videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()})}function clearCards(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}function createCard(e){var t=document.createElement("div"),o=(t.className="shared-moment-card mdl-card mdl-shadow--2dp",document.createElement("div")),n=(o.className="mdl-card__title",o.style.backgroundImage="url("+e.image+")",o.style.backgroundSize="cover",t.appendChild(o),document.createElement("h2")),o=(n.style.color="white",n.className="mdl-card__title-text",n.textContent=e.title,o.appendChild(n),document.createElement("div"));o.className="mdl-card__supporting-text",o.textContent=e.location,o.style.textAlign="center",t.appendChild(o),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function updateUI(e){for(var t=0;t<e.length;t++)createCard(e[t])}captureButton.addEventListener("click",function(e){captureButton.style.display="none",videoPlayer.style.display="none",canvasElement.style.display="block",canvasElement.getContext("2d").drawImage(videoPlayer,0,0,canvasElement.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvasElement.width)),videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()}),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",function(e){picture=e.target.files[0]}),locationBtn.addEventListener("click",function(){"geolocation"in navigator&&(locationBtn.style.display="none",locationLoader.style.display="block",navigator.geolocation.getCurrentPosition(function(e){locationBtn.style.display="inline",locationLoader.style.display="none",fetchedLocation=e},function(e){locationBtn.style.display="inline",locationLoader.style.display="none",fetchedLocation=null,alert("location detection doesn't work")},{timeout:5e3}),locationInput.value="Bangalore")}),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);var url="https://pwagram-39d1e-default-rtdb.firebaseio.com/posts.json",networkDataReceived=!1;function sendData(){var e=(new Date).toISOString();fetch(url,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({id:e,title:titleInput.value,location:locationInput.value,image:"image"})}).then(function(e){console.log("sent data",e)})}fetch(url).then(function(e){return e.json()}).then(function(e){networkDataReceived=!0,clearCards();var t=[];for(key in e)t.push(e[key]);updateUI(t)}),"indexedDB"in window&&readAllData("posts").then(function(e){networkDataReceived||(clearCards(),updateUI(e))}),form.addEventListener("submit",function(e){e.preventDefault(),""===titleInput.value.trim()||""===locationInput.value.trim()?alert("enter valid data!"):(closeCreatePostModal(),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(function(e){var t={id:(new Date).toISOString(),title:titleInput.value,location:locationInput.value,picture:picture};writeData("sync-posts",t).then(function(){return e.sync.register("sync-new-post")}).then(function(){document.querySelector("#confirmation-toast").MaterialSnackbar.showSnackbar({message:"your post has been saved for syncing!!!"})}).catch(function(e){console.log()})}):sendData())});